<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Message Details - M365 Iron Backup</title>
    <link rel="stylesheet" href="/static/catppuccin.css">
    <style>
      .message-container {
        max-width: 1000px;
        margin: 2rem auto;
      }
      .message-header {
        background: var(--ctp-surface0);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
      }
      .message-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .action-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      .action-btn:hover { opacity: 0.8; }
      .btn-download { background: var(--ctp-blue); color: var(--ctp-base); }
      .btn-back { background: var(--ctp-surface2); color: var(--ctp-text); }
      .message-meta {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.5rem 1rem;
        margin-bottom: 2rem;
        font-size: 0.9rem;
      }
      .meta-label {
        font-weight: bold;
        color: var(--ctp-text);
        text-align: right;
      }
      .meta-value {
        color: var(--ctp-subtext1);
        word-break: break-all;
      }
      .message-subject {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--ctp-text);
        margin-bottom: 1rem;
        word-wrap: break-word;
      }
      .message-body {
        background: var(--ctp-surface0);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
      }
      .body-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--ctp-overlay0);
        padding-bottom: 0.5rem;
      }
      .body-tab {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px 4px 0 0;
        background: var(--ctp-surface1);
        color: var(--ctp-text);
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .body-tab.active {
        background: var(--ctp-blue);
        color: var(--ctp-base);
      }
      .body-tab:hover:not(.active) {
        background: var(--ctp-surface2);
      }
      .body-content {
        display: none;
        line-height: 1.6;
        color: var(--ctp-text);
      }
      .body-content.active {
        display: block;
      }
      .body-text {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
      }
      .body-html {
        border: 1px solid var(--ctp-overlay0);
        border-radius: 4px;
        padding: 1rem;
        background: white;
        color: black;
        min-height: 300px;
      }
      .attachments-section {
        background: var(--ctp-surface0);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
      }
      .attachment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--ctp-surface1);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }
      .attachment-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .attachment-name {
        font-weight: bold;
        color: var(--ctp-text);
      }
      .attachment-meta {
        font-size: 0.8rem;
        color: var(--ctp-subtext0);
      }
      .raw-json {
        background: var(--ctp-surface0);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 8px;
        padding: 2rem;
      }
      .json-content {
        background: var(--ctp-surface1);
        border: 1px solid var(--ctp-overlay0);
        border-radius: 6px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: var(--ctp-text);
        white-space: pre;
        overflow-x: auto;
        max-height: 500px;
        overflow-y: auto;
      }
      .empty-content {
        text-align: center;
        padding: 2rem;
        color: var(--ctp-subtext0);
        font-style: italic;
      }
      .priority-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      .priority-high { background: var(--ctp-red); color: var(--ctp-base); }
      .priority-normal { background: var(--ctp-surface2); color: var(--ctp-text); }
      .priority-low { background: var(--ctp-overlay1); color: var(--ctp-subtext1); }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--ctp-overlay0);">
        <h1>üìß Message Details</h1>
        <nav class="nav-links" style="display: flex; gap: 1rem;">
          <a href="/" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üè† Dashboard</a>
          <a href="/tenants" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üë• Tenants</a>
          <a href="/backup" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üöÄ Backup</a>
          <a href="/search" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üîç Search</a>
        </nav>
      </div>

      <div class="message-container">
        
        <!-- Message Actions -->
        <div class="message-actions">
          <a href="/api/message/{{ message_id }}/eml" class="action-btn btn-download" download>
            üì• Download EML
          </a>
          <a href="/snapshots/{{ message.snapshot_id }}" class="action-btn btn-back">
            ‚Üê Back to Snapshot
          </a>
        </div>

        <!-- Message Header -->
        <div class="message-header">
          <div class="message-subject">{{ message.subject or 'No Subject' }}</div>
          
          <div class="message-meta">
            <div class="meta-label">From:</div>
            <div class="meta-value">{{ message.from_address or 'Unknown' }}</div>
            
            {% if message.raw_message.get('toRecipients') %}
            <div class="meta-label">To:</div>
            <div class="meta-value">
              {% for recipient in message.raw_message.toRecipients %}
                {{ recipient.emailAddress.address }}{% if not loop.last %}, {% endif %}
              {% endfor %}
            </div>
            {% endif %}
            
            {% if message.raw_message.get('ccRecipients') %}
            <div class="meta-label">CC:</div>
            <div class="meta-value">
              {% for recipient in message.raw_message.ccRecipients %}
                {{ recipient.emailAddress.address }}{% if not loop.last %}, {% endif %}
              {% endfor %}
            </div>
            {% endif %}
            
            <div class="meta-label">Date:</div>
            <div class="meta-value">
              {{ message.received_datetime.strftime('%Y-%m-%d %H:%M:%S UTC') if message.received_datetime else 'Unknown' }}
            </div>
            
            <div class="meta-label">User:</div>
            <div class="meta-value">{{ message.user_principal or 'Unknown' }}</div>
            
            <div class="meta-label">Message ID:</div>
            <div class="meta-value">{{ message.message_id or 'Unknown' }}</div>
            
            <div class="meta-label">Priority:</div>
            <div class="meta-value">
              <span class="priority-badge priority-{{ message.importance or 'normal' }}">
                {{ message.importance or 'normal' }}
              </span>
            </div>
            
            {% if message.has_attachments %}
            <div class="meta-label">Attachments:</div>
            <div class="meta-value">üìé {{ message.attachment_count }} attachment(s)</div>
            {% endif %}
          </div>
        </div>

        <!-- Message Body -->
        <div class="message-body">
          <h3>Message Content</h3>
          
          <div class="body-tabs">
            {% if message.body_text %}
            <button class="body-tab active" onclick="showBodyTab('text')">Plain Text</button>
            {% endif %}
            {% if message.body_html %}
            <button class="body-tab {% if not message.body_text %}active{% endif %}" onclick="showBodyTab('html')">HTML</button>
            {% endif %}
            {% if not message.body_text and not message.body_html %}
            <button class="body-tab active" onclick="showBodyTab('empty')">No Content</button>
            {% endif %}
          </div>
          
          {% if message.body_text %}
          <div id="body-text" class="body-content active">
            <div class="body-text">{{ message.body_text }}</div>
          </div>
          {% endif %}
          
          {% if message.body_html %}
          <div id="body-html" class="body-content {% if not message.body_text %}active{% endif %}">
            <div class="body-html">
              <iframe srcdoc="{{ message.body_html|e }}" 
                      style="width: 100%; height: 400px; border: none; border-radius: 4px;">
              </iframe>
            </div>
          </div>
          {% endif %}
          
          {% if not message.body_text and not message.body_html %}
          <div id="body-empty" class="body-content active">
            <div class="empty-content">No message content available</div>
          </div>
          {% endif %}
        </div>

        <!-- Attachments -->
        {% if message.raw_message.get('attachments') %}
        <div class="attachments-section">
          <h3>Attachments ({{ message.attachment_count }})</h3>
          
          {% for attachment in message.raw_message.attachments %}
          <div class="attachment-item">
            <div class="attachment-info">
              <div class="attachment-name">üìé {{ attachment.name or 'Unnamed Attachment' }}</div>
              <div class="attachment-meta">
                Type: {{ attachment.contentType or 'unknown' }}
                {% if attachment.size %}
                | Size: {{ "%.1f"|format(attachment.size / 1024) }} KB
                {% endif %}
              </div>
            </div>
            <div>
              <span style="color: var(--ctp-subtext0); font-size: 0.8rem;">
                Saved in EML file
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Raw JSON Data -->
        <div class="raw-json">
          <h3>Raw Message Data</h3>
          <div class="json-content">{{ message.raw_json }}</div>
        </div>

      </div>
    </div>

    <script>
      function showBodyTab(tabName) {
        // Hide all tabs and content
        document.querySelectorAll('.body-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.body-content').forEach(content => content.classList.remove('active'));
        
        // Show selected tab and content
        event.target.classList.add('active');
        const contentId = `body-${tabName}`;
        const contentEl = document.getElementById(contentId);
        if (contentEl) {
          contentEl.classList.add('active');
        }
      }
    </script>
  </body>
</html>