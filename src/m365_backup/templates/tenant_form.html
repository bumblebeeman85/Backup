<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ "Edit" if action == "edit" else "Add New" }} Tenant - M365 Iron Backup</title>
    <link rel="stylesheet" href="/static/catppuccin.css">
    <style>
      .form-container {
        max-width: 600px;
        margin: 2rem auto;
        background: var(--ctp-surface0);
        padding: 2rem;
        border-radius: 8px;
        border: 1px solid var(--ctp-overlay0);
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: var(--ctp-text);
      }
      .form-group input, .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--ctp-overlay1);
        border-radius: 6px;
        background: #ffffff;
        color: #2c3e50;
        font-family: inherit;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .form-group input:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--ctp-blue);
        box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.2);
      }
      .form-group textarea {
        height: 120px;
        resize: vertical;
        font-family: monospace;
      }
      .form-group small {
        color: var(--ctp-subtext0);
        font-size: 0.9rem;
        margin-top: 0.25rem;
        display: block;
      }
      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
        font-size: 1rem;
        margin-right: 1rem;
      }
      .btn-primary { background: var(--ctp-blue); color: var(--ctp-base); }
      .btn-secondary { background: var(--ctp-surface2); color: var(--ctp-text); }
      .btn:hover { opacity: 0.8; }
      .error {
        background: var(--ctp-red);
        color: var(--ctp-base);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
      }
      .required {
        color: var(--ctp-red);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--ctp-overlay0);">
        <h1>{{ "Edit Tenant" if action == "edit" else "Add New Tenant" }}</h1>
        <nav class="nav-links" style="display: flex; gap: 1rem;">
          <a href="/" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üè† Dashboard</a>
          <a href="/tenants" style="padding: 0.5rem 1rem; background: var(--ctp-blue); color: var(--ctp-base); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üë• Tenants</a>
          <a href="/backup" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üöÄ Backup</a>
          <a href="/search" style="padding: 0.5rem 1rem; background: var(--ctp-surface1); color: var(--ctp-text); text-decoration: none; border-radius: 4px; border: 1px solid var(--ctp-overlay0);">üîç Search</a>
        </nav>
      </div>

      <div class="form-container">
        
        {% if error %}
        <div class="error">
          <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <form method="post">
          <div class="form-group">
            <label for="name">Tenant Name <span class="required">*</span></label>
            <input type="text" id="name" name="name" value="{{ tenant.name if tenant else '' }}" required>
            <small>A friendly name for this tenant (e.g., "ACME Corp")</small>
          </div>

          <div class="form-group">
            <label for="tenant_id">Tenant ID <span class="required">*</span></label>
            <input type="text" id="tenant_id" name="{{ 'tenant_id_field' if action == 'edit' else 'tenant_id' }}" value="{{ tenant.tenant_id if tenant else '' }}" required>
            <small>Your Microsoft 365 Tenant ID (GUID format)</small>
          </div>

          <div class="form-group">
            <label for="client_id">Client ID <span class="required">*</span></label>
            <input type="text" id="client_id" name="client_id" value="{{ tenant.client_id if tenant else '' }}" required>
            <small>Azure App Registration Client ID</small>
          </div>

          <div class="form-group">
            <label for="client_secret">Client Secret <span class="required">*</span></label>
            <input type="password" id="client_secret" name="client_secret" value="{{ tenant.client_secret if tenant else '' }}" required>
            <small>Azure App Registration Client Secret</small>
          </div>

          <div class="form-group">
            <div style="background: var(--ctp-green); color: var(--ctp-base); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
              <strong>‚ú® Automatic Mailbox Discovery</strong><br>
              <small>This system automatically discovers and backs up ALL active mailboxes in your tenant, including:</small>
              <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.9rem;">
                <li>üë§ User mailboxes (all active users)</li>
                <li>üì´ Shared mailboxes</li>
                <li>üìß Distribution group mailboxes</li>
              </ul>
              <small>No need to manually specify users - inactive mailboxes are automatically skipped!</small>
            </div>
          </div>

          <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">
              {{ "üíæ Update Tenant" if action == "edit" else "‚ûï Create Tenant" }}
            </button>
            <a href="/tenants" class="btn btn-secondary">‚ùå Cancel</a>
          </div>
        </form>

        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--ctp-overlay0);">
          <h3>üìã Azure App Registration Requirements</h3>
          <p><small>Ensure your Azure App Registration has these API permissions:</small></p>
          <ul style="font-size: 0.9rem; color: var(--ctp-subtext0);">
            <li><strong>Mail.Read</strong> (Application permission) - To read all mailboxes</li>
            <li><strong>User.Read.All</strong> (Application permission) - To enumerate users and mailboxes</li>
            <li><strong>Group.Read.All</strong> (Application permission) - To discover shared mailboxes</li>
          </ul>
          <p style="font-size: 0.9rem; color: var(--ctp-yellow); margin-top: 1rem;">
            ‚ö†Ô∏è Make sure to <strong>grant admin consent</strong> for all permissions in the Azure portal!
          </p>
        </div>
      </div>
    </div>

    <script>
      // Auto-format tenant ID as GUID
      document.getElementById('tenant_id').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^a-fA-F0-9-]/g, '');
        // Basic GUID format validation could go here
        e.target.value = value;
      });

      // Auto-format client ID as GUID
      document.getElementById('client_id').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^a-fA-F0-9-]/g, '');
        e.target.value = value;
      });
    </script>
  </body>
</html>